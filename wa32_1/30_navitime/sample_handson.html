<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <style>
    #map {
      width: 800px;
      height: 450px;
      background-color: black;
    }
  </style>
  <script src='http://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
</head>

<body>
  <h1>ルート線表示 サンプルコード</h1>
  <div>
    <input type="text" name="start" value="ナビタイムジャパン">
    <input type="text" name="goal" value="東京駅">
    <button type="button" onclick="search()">ルート線を表示</button>
  </div>
  <div id="loading" style="display:none;">検索中...</div>
  <div id="map"></div>

  <!-- axiosを使用するために必要な記載です -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <!-- 地図を取得しています -->
  <!-- {SID}の部分にはお伝えしたSIDを設定してください -->
  <script src="https://api-challenge.navitime.biz/v1s/{SID}/mapscript?host=localhost"></script>

  <script>
    /**
     * 初期処理
     */
    function main() {
      // 地図の中心点を定義
      center = new navitime.geo.LatLng('35.667395', '139.714896')
      // 地図を描画
      map = new navitime.geo.Map('map', center, 15)
    }

    // 画面読み込み時に実行
    window.onload = main
  </script>

  <script>
    // APIアクセス時の固定部
    // {SID}の部分にはお伝えしたSIDを設定してください
    const baseUrl = 'https://api-challenge.navitime.biz/v1s/{SID}';
    // ルート線オブジェクト
    let renderer = null;
    // 出発地点オブジェクト
    let start = null;
    // 到着地点オブジェクト
    let goal = null;

    /**
     * ルート検索開始
     */
    function search() {
      // 検索開始
      $('#loading').show();

      searchStartSpot();
    }

    /**
     * 出発地点検索
     */
    function searchStartSpot() {
      // フォームから出発地点のキーワードを取得
      const name = $('input[name=start]').val();
      // スポット検索リクエストURL
      const url = `${baseUrl}/spot/list?word=${name}&datum=wgs84`;

      // mochaリクエストをコンソールで確認
      console.log(url);

      axios
        // GETリクエスト
        .get(url)
        // 通信成功時に実行する関数
        .then(searchGoalSpot)
        // エラー発生時に実行する関数
        .catch(connectFailure);
    }

    /**
     * 到着地点検索
     * @param {Object} response 出発地点検索レスポンス
     */
    function searchGoalSpot(response) {
      // APIレスポンスをコンソールで確認
      console.log(response);
      // 出発地点を設定
      start = response.data.items[0];

      // フォームから到着地点のキーワードを取得
      const name = $('input[name=goal]').val();
      // スポット検索リクエストURL
      const url = `${baseUrl}/spot/list?word=${name}&datum=wgs84`;

      axios
        // GETリクエスト
        .get(url)
        // 通信成功時に実行する関数
        .then(searchRoute)
        // エラー発生時に実行する関数
        .catch(connectFailure);
    }

    /**
     * ルート形式検索
     * @param {Object} response 到着地点検索レスポンス
     */
    function searchRoute(response) {
      // APIレスポンスをコンソールで確認
      console.log(response);
      // 到着地点を設定
      goal = response.data.items[0];

      // ルート形式検索リクエストURL
      const url = `${baseUrl}/route/shape?start=${start.coord.lat},${start.coord.lon}&goal=${goal.coord.lat},${goal.coord.lon}&add=transport_shape&shape-color=railway_line&datum=wgs84`;

      axios
        // GETリクエスト
        .get(url)
        // 通信成功時に実行する関数
        .then(showRouteShape)
        // エラー発生時に実行する関数
        .catch(connectFailure);
    }

    /**
     * ルート線表示
     * @param {Object} response ルート線検索レスポンス
     */
    function showRouteShape(response) {
      // APIレスポンスをコンソールで確認
      console.log(response);

      // 前回のルート線を削除
      if (renderer) {
        renderer.destroy();
      }

      // ルート線を地図上に描画
      const route = response.data;
      renderer = new navitime.geo.route.Renderer(route, {
        map: map,
        unit: 'degree',
        allRoute: true,       // すべてのルートを表示するか
        arrow: true,          // ルート線上に進行方向の矢印を表示するか
        originalColor: true,  // 路線形状に指定された元々の色を利用するか
      });
      renderer.draw();

      // 検索終了
      $('#loading').hide();
    }

    /**
     * エラーハンドラ
     * @param {Object} error エラーオブジェクト
     */
    function connectFailure(error) {
      alert(error);
    }

  </script>
</body>

</html>