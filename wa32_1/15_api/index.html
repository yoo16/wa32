<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css">
  <link rel="stylesheet" href="css/prism.css">
  <link rel="stylesheet" href="css/default.css">

  <title>WA32_1</title>
</head>

<body>
  <div id="content" class="container">
    <h1 class="h1">API</h1>
    <p><a href="../">Back</a></p>

    <div>
      <h2 class="h2">API とは</h2>
      <p>
        Web を利用していると「API」という文字を目にしたり、現場でもよく飛び交う言葉ではないでしょうか。
      </p>
      <p>
        API（Application Programming Interface）は直訳すると、アプリケーションをプログラミングするためのインターフェースです。
      </p>

      <h3 class="h3">インターフェイスとは</h3>
      <p>
        インターフェイス（Interface）はプログラミングだけに限らず利用される言葉で「操作をする手順・規則」といった意味があります。
      </p>
      <ul>
        <li>ユーザインターフェイス</li>
        <li>デバイスのインターフェイス</li>
        <li>プログラミングのインターフェイス</li>
      </ul>

      <p>
        などありますが、ソフトウェアの場合 API は外部アプリからアクセスできるよう設計された窓口です。
      </p>

      <h3 class="h3">Web API</h3>
      <p>
        Web API は SNS、天気情報、交通情報といった無数のデータを、各会社や個人がインターネットを介してサービス提供しています。
      </p>
      <ul>
        <li>
          <a href="https://cloud.google.com/maps-platform/?hl=ja" target="_blank">Google Maps Platform</a>
        </li>
        <li>
          <a href="https://api.rakuten.co.jp/ja/" target="_blank">Rakuten Rapid API</a>
        </li>
        <li>
          <a href="https://zipcloud.ibsnet.co.jp/doc/api" target="_blank">郵便番号検索API</a>
        </li>
      </ul>

      <h2 class="h2">API の利用制限を調べる</h2>
      <p class="alert alert-info">
        API を利用するには各サービスごとに、有料・無料や利用制限を確認する必要があります。
      </p>
      <p>
        一般的な API は、サイトにアカウント登録して制限をかけるものが多いでが、中にはアカウント登録なしで無料で利用できるものもあります。
        ただし、
      </p>
      <p class="alert alert-danger">
        各サービスによって回数制限をかけられるため、攻撃的なアクセスをしないよう注意が必要です。
      </p>
    </div>

    <h2 class="h2">非同期通信</h2>
    <p>
      クライアントとサーバのデータ通信において「同期」と「非同期通信」に分けられます。
    </p>
    <p>
      「同期通信」はクライアントからサーバにリクエストするとレスポンスがくるまで待ちますが、レスポンスがくるまで他の処理ができません。
    </p>
    <p class="alert alert-info">
      「非同期通信」を利用すると、サーバからレスポンスを待ちながら他の処理が実行できます。
    </p>
    <p>
      サーバからレスポンスが返ってきたら、処理を続行します。
    </p>

    <h2 class="h2">XMLHttpRequest</h2>
    <p class="alert alert-info">
      XMLHttpRequest(XHR) は、クライアントとサーバーと HTTP通信するためにブラウザに用意された API です。
    </p>
    <p>
      XMLHttpRequest を利用するとサーバーとデータ送受信することができ、JavaScript ネイティブでは XMLHttpRequest() 利用します。
    </p>
    <pre class="language-javascript"><code>
    let request = new XMLHttpRequest();
    </code></pre>

    <div>
      <h2 class="h2">データフォーマット</h2>
      <p>
        XMLHttpRequest でデータ通信する場合、クライアントとサーバーのデータ通信には決められたテキストデータフォーマットが必要です。
      </p>
      <h3 class="h3">XML</h3>
      <p>
        そのデータフォーマットで利用されるのが「XML」というもので、 HTML 同様の DOM（Document Object Model）のツリー構造の言語です。
      </p>

      <pre class="language-markup"><code>
      &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
      &lt;foods&gt;
        &lt;food&gt;
          &lt;name&gt;Apple&lt;/name&gt;
          &lt;price&gt;180&lt;/price&gt;
        &lt;/food&gt;

        &lt;food&gt;
          &lt;name&gt;Banana&lt;/name&gt;
          &lt;price&gt;200&lt;/price&gt;
        &lt;/food&gt;
      &lt;/foods&gt;
      </code></pre>

      <h3 class="h3">JSON</h3>
      <p>
        JSONは JavaScript Object Notation の略で、<a href="https://www.ietf.org/rfc/rfc4627" target="_blank">RFC 4627</a>
        に準拠した
        XML に代わるテキストデータフォーマットです。
      </p>
      <p class="alert alert-info">
        データフォーマットは XML がデータ構造上大きく負荷がかかる傾向にあるため、JSON が多く利用されます。
      </p>
      <pre class="language-javascript"><code>
      {
        "foods": [
          {"name":"apple","price":180},
          {"name":"banana","price":150}
        ]
      }
      </code></pre>
      <p>
        また、JavaScript で利用できるデータフォーマットで開発されているため、ライブラリは必要ありません。
        他の言語では JSON を扱うためのライブラリが必要です。
      </p>
    </div>


    <div>
      <h2 class="h2">コールバック（callback）</h2>
      <p class="alert alert-info">
        コールバック（callback）は関数を変数定義し、他の関数で実行できるようにする仕組みです。
      </p>
      <p>
        サーバにリクエストして結果が返ってきたら実行する非同期処理でよく利用されます。
      </p>
      <h3 class="h3">変数指定で関数を実行</h3>
      <pre class="language-javascript"><code>
      let methods = {
          hello: {
              callback: function (name) {
                  $('#result').text('callback:' + name)
              }
          },
          bye: {
              callback: function (name) {
                  $('#result').text('callback:' + name)
              }
          },
      };
      
      function main(key) {
          methods[key].callback(key);
      }
      
      main('hello');
      </code></pre>

      <h3 class="h3">サーバ通信のコールバック</h3>
      <p>
        サーバにリクエストして通信を利用してコールバックを実行した例です。
      </p>
      <pre class="language-javascript"><code>
      let successCallback = function() {
          console.log('success');
      }
      let errorCallback = function() {
          console.log('error');
      }
      let url = 'http://localhost/api/test';
      $.ajax({
          url: url,
          type: 'get',
          dataType: 'json',
      }).done(function(result) {
          successCallback();
      }).fail(function(result) {
          errorCallback();
      });
      </code></pre>
    </div>

    <div>
      <h2 class="h2">CORS</h2>
      <p class="alert alert-info">
        CORS (Cross-Origin Resource Sharing) は、クロスドメイン（異なるドメイン）間で通信を共有する仕組みです。
      </p>
      <p>
        クロスドメイン間の通信を安易に許可してしまうと、悪意のあるプログラムから攻撃対象となるためデフォルトでは通信はできません。
      </p>
      <p>
        例えば自分のサーバ（localhost）から、他のサーバ（google.com）へのリクエストは、他のサーバが許可しない限り、エラーとなります。
      </p>
      <h3 class="h3">Origin とは</h3>
      <p>
        Origin は ドメインに「プロトコル」「ポート番号」を追加したものです。
      </p>
      <pre class="language-javascript"><code>
        http://localhost:80
      </code></pre>

      <p class="alert alert-info">
        ある Origin サーバーアプリから、別の Origin サーバーへのリクエストを許可することで、クロスドメイン間での通信が実現できます。
      </p>
    </div>

    <div>
      <h2 class="h2">JSONP</h2>
      <p>
        クロスドメイン間の通信が確立されても、JavaScript（jQuery）ではそもままデータ通信ができません。
      </p>
      <p class="alert alert-info">
        JSONP（JSON with Padding）は、JavaScript 上でクロスドメイン制限を超えたデータ通信を実現します。
      </p>
      <p>
        実際には別ドメインに対して JavaScript の実行権限をあたえる行為なので、信頼できるドメインに対して利用する必要があります。
      </p>

      <p>
        jQuery の $.ajax() を利用した例です。
      </p>
      <pre class="language-javascript"><code>
      $.ajax({
          url: url,
          type: 'get',
          dataType: 'jsonp',
          xhrFields: {
              withCredentials: true
          },
      }).done(function(result) {
          eventList.html('');
          event.callback(result);
      }).fail(function(result) {
          console.log(result);
      });
      </code></pre>
    </div>

    <div>
      <h2 class="h2">ローカル環境でサーバ（API）をテストする</h2>
      <p class="alert alert-info">
        ローカル環境で API リクエストをテストしたいとき、原則 Webサーバが必要になります。
      </p>
      <p>
        リクエストする側と APIサーバ側を同じドメイン（localhost など）に配置するのがシンプルです。
      </p>
      <h3 class="h3">直接 HTMLファイルを実行すると CORSエラー</h3>
      <p>
        HTML ファイルを直接開いて JavaScript を実行する場合は CORSエラーとなります。
      </p>
      <pre class="language-javascript"><code>
        Access to XMLHttpRequest at 'file:///Users/...' from origin 'null' 
        has been blocked by CORS policy: Cross origin requests are 
        only supported for protocol schemes: http, data, chrome, chrome-extension, https.
      </code></pre>
      <p>
        Chrome や FireFox などのブラウザが、file プロトコルを原則許可しないのが原因です。
      </p>
      <h3 class="h3">ローカル環境に Webサーバがない場合</h3>
      <p>
        ローカル環境に Webサーバがない場合、VSCode でも一時的にサーバをたてることができます。
      </p>
      <p>
        <a href="https://marketplace.visualstudio.com/items?itemName=ritwickdey.LiveServer" target="_blank">Live Server</a>
      </p>
      <p>
        ただし色々な問題が出る可能性があるので、Web サーバは用意しておきましょう。
      </p>
    </div>

  </div>


  <script src="../js/jquery-3.5.0.min.js"></script>
  <script src="../js/bootstrap/bootstrap.min.js"></script>
  <script src="../js/prism.js"></script>
</body>

</html>